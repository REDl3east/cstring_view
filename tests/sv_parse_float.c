#define SV_IMPLEMENTATION
#include "sv.h"

#include <stdio.h>

int test_sv_parse_float(cstring_view input, int will_fail, float expected);
int float_equals(float a, float b);

void print_check();
void print_x();

#define EPSILON 0.001f

#define TEST_PARSE_FLOAT(num)                                     \
  do {                                                            \
    if (!test_sv_parse_float(svl(#num), 0, (float)num)) return 1; \
  } while (0)

#define TEST_PARSE_FLOAT_FAIL(num)                      \
  do {                                                  \
    if (!test_sv_parse_float(svl(num), 1, 0)) return 1; \
  } while (0)

int main() {
  TEST_PARSE_FLOAT(10);
  TEST_PARSE_FLOAT(4234);
  TEST_PARSE_FLOAT(5555);
  TEST_PARSE_FLOAT(6766666);
  TEST_PARSE_FLOAT(5645654);
  TEST_PARSE_FLOAT(5645654e0);
  TEST_PARSE_FLOAT(5645654e+0);
  TEST_PARSE_FLOAT(5645654e-0);
  TEST_PARSE_FLOAT(10.556);
  TEST_PARSE_FLOAT(10.556e1);
  TEST_PARSE_FLOAT(10.556e+1);
  TEST_PARSE_FLOAT(10.556e-1);
  TEST_PARSE_FLOAT(+10);
  TEST_PARSE_FLOAT(+4234);
  TEST_PARSE_FLOAT(+5555);
  TEST_PARSE_FLOAT(+6766666);
  TEST_PARSE_FLOAT(+5645654);
  TEST_PARSE_FLOAT(+5645654e0);
  TEST_PARSE_FLOAT(+5645654e+0);
  TEST_PARSE_FLOAT(+5645654e-0);
  TEST_PARSE_FLOAT(+10.556);
  TEST_PARSE_FLOAT(+10.556e1);
  TEST_PARSE_FLOAT(+10.556e+1);
  TEST_PARSE_FLOAT(+10.556e-1);
  TEST_PARSE_FLOAT(10.0);
  TEST_PARSE_FLOAT(10.0000000000000000000);
  TEST_PARSE_FLOAT(10.5);
  TEST_PARSE_FLOAT(10.525000000000);
  TEST_PARSE_FLOAT(10.5e3);
  TEST_PARSE_FLOAT(10.5e6);
  TEST_PARSE_FLOAT(5e2);
  TEST_PARSE_FLOAT(5e-2);
  TEST_PARSE_FLOAT(568.127);
  TEST_PARSE_FLOAT(5e-5);
  TEST_PARSE_FLOAT(0.25);
  TEST_PARSE_FLOAT(0000.025);
  TEST_PARSE_FLOAT(-10);
  TEST_PARSE_FLOAT(-5645654);
  TEST_PARSE_FLOAT(-5645654e0);
  TEST_PARSE_FLOAT(-5645654e+0);
  TEST_PARSE_FLOAT(-5645654e-0);
  TEST_PARSE_FLOAT(-10.556);
  TEST_PARSE_FLOAT(-10.556e1);
  TEST_PARSE_FLOAT(-10.556e+1);
  TEST_PARSE_FLOAT(-10.556e-1);
  TEST_PARSE_FLOAT(-10.0);
  TEST_PARSE_FLOAT(-10.0000000000000000000);
  TEST_PARSE_FLOAT(-10.5);
  TEST_PARSE_FLOAT(-10.5e3);
  TEST_PARSE_FLOAT(-10.5e6);
  TEST_PARSE_FLOAT(-5e2);
  TEST_PARSE_FLOAT(-5e-2);
  TEST_PARSE_FLOAT(-568.127);
  TEST_PARSE_FLOAT(-5e-5);
  TEST_PARSE_FLOAT(-0.25);
  TEST_PARSE_FLOAT(-0000.025);
  TEST_PARSE_FLOAT(-1.001);
  TEST_PARSE_FLOAT(+1.001);
  TEST_PARSE_FLOAT(.25);
  TEST_PARSE_FLOAT(.25e5);
  TEST_PARSE_FLOAT(.25e+5);
  TEST_PARSE_FLOAT(.25e-5);
  TEST_PARSE_FLOAT(5.);
  TEST_PARSE_FLOAT(5.0);
  TEST_PARSE_FLOAT(5.e2);
  TEST_PARSE_FLOAT(5.e+2);
  TEST_PARSE_FLOAT(5.e-2);
  TEST_PARSE_FLOAT(-.25);
  TEST_PARSE_FLOAT(-100);
  TEST_PARSE_FLOAT(-100e-2);
  TEST_PARSE_FLOAT(-148e+2);
  TEST_PARSE_FLOAT(-1.25e+2);
  TEST_PARSE_FLOAT(-1.25e+002);
  TEST_PARSE_FLOAT(+.25);
  TEST_PARSE_FLOAT(+100);
  TEST_PARSE_FLOAT(+100e-2);
  TEST_PARSE_FLOAT(+148e+2);
  TEST_PARSE_FLOAT(+1.25e+2);

  TEST_PARSE_FLOAT_FAIL("5ee10");
  TEST_PARSE_FLOAT_FAIL("10.0008O3");
  TEST_PARSE_FLOAT_FAIL("+10.0008O3");
  TEST_PARSE_FLOAT_FAIL("+10.0008O3e10");
  TEST_PARSE_FLOAT_FAIL("+10.eO3");
  TEST_PARSE_FLOAT_FAIL("10O.45");
  TEST_PARSE_FLOAT_FAIL("10f");
  TEST_PARSE_FLOAT_FAIL("423x4");
  TEST_PARSE_FLOAT_FAIL("55v55");
  TEST_PARSE_FLOAT_FAIL("676v6666");
  TEST_PARSE_FLOAT_FAIL("564565z4");
  TEST_PARSE_FLOAT_FAIL("5645#654e0");
  TEST_PARSE_FLOAT_FAIL("56v45654e+0");
  TEST_PARSE_FLOAT_FAIL("5645654e-c0");
  TEST_PARSE_FLOAT_FAIL("10.55x6");
  TEST_PARSE_FLOAT_FAIL("1x0.556e1");
  TEST_PARSE_FLOAT_FAIL("10.556e+e1");
  TEST_PARSE_FLOAT_FAIL("10.556ec-1");
  TEST_PARSE_FLOAT_FAIL("+v10");
  TEST_PARSE_FLOAT_FAIL("+4234e");
  TEST_PARSE_FLOAT_FAIL("+e5555");
  TEST_PARSE_FLOAT_FAIL("+e6766666");
  TEST_PARSE_FLOAT_FAIL("+5645v654");
  TEST_PARSE_FLOAT_FAIL("+56456x54e0");
  TEST_PARSE_FLOAT_FAIL("+5645654e+0x");
  TEST_PARSE_FLOAT_FAIL("+5645654ev-0");
  TEST_PARSE_FLOAT_FAIL("+10c.556");
  TEST_PARSE_FLOAT_FAIL("+10.55e6e1");
  TEST_PARSE_FLOAT_FAIL("+10.5e56e+1");
  TEST_PARSE_FLOAT_FAIL("+1e0.556e-1");
  TEST_PARSE_FLOAT_FAIL("10.0e");
  TEST_PARSE_FLOAT_FAIL("10.00000e00000000000000e");
  TEST_PARSE_FLOAT_FAIL("10e.5");
  TEST_PARSE_FLOAT_FAIL("10e.525000000000");
  TEST_PARSE_FLOAT_FAIL("10e.5e3");
  TEST_PARSE_FLOAT_FAIL("10.5ee6");
  TEST_PARSE_FLOAT_FAIL("5eeee2");
  TEST_PARSE_FLOAT_FAIL("5e-e2");
  TEST_PARSE_FLOAT_FAIL("568.e12e7");
  TEST_PARSE_FLOAT_FAIL("5e-5f");
  TEST_PARSE_FLOAT_FAIL("0e.25");
  TEST_PARSE_FLOAT_FAIL("00c0.025");
  TEST_PARSE_FLOAT_FAIL("-10c");
  TEST_PARSE_FLOAT_FAIL("-56456c54");
  TEST_PARSE_FLOAT_FAIL("-56x45654e0");
  TEST_PARSE_FLOAT_FAIL("-5645v654e+0");
  TEST_PARSE_FLOAT_FAIL("-5645654we-0");
  TEST_PARSE_FLOAT_FAIL("-10.x556");
  TEST_PARSE_FLOAT_FAIL("-10x.556e1");
  TEST_PARSE_FLOAT_FAIL("-10.5w56e+1");
  TEST_PARSE_FLOAT_FAIL("-10.556e-1xx");
  TEST_PARSE_FLOAT_FAIL("-10.x0");
  TEST_PARSE_FLOAT_FAIL("-10.000x0000000000000000");
  TEST_PARSE_FLOAT_FAIL("-10.e5w");
  TEST_PARSE_FLOAT_FAIL("-1s0.5e3");
  TEST_PARSE_FLOAT_FAIL("-10x.5e6");
  TEST_PARSE_FLOAT_FAIL("-5e2v");
  TEST_PARSE_FLOAT_FAIL("-5e-v2");
  TEST_PARSE_FLOAT_FAIL("-5 68.127");
  TEST_PARSE_FLOAT_FAIL("-5e -5");
  TEST_PARSE_FLOAT_FAIL("-0. 25");
  TEST_PARSE_FLOAT_FAIL("-000 0.025");
  TEST_PARSE_FLOAT_FAIL("-1.0 01");
  TEST_PARSE_FLOAT_FAIL("+1.00 1");
  TEST_PARSE_FLOAT_FAIL(".2 5");
  TEST_PARSE_FLOAT_FAIL(".2 5e5");
  TEST_PARSE_FLOAT_FAIL(".2 5e+5");
  TEST_PARSE_FLOAT_FAIL(".25e- 5");
  TEST_PARSE_FLOAT_FAIL("5. ");
  TEST_PARSE_FLOAT_FAIL("5. 0");
  TEST_PARSE_FLOAT_FAIL("5 .e2");
  TEST_PARSE_FLOAT_FAIL("5.e+2 ");
  TEST_PARSE_FLOAT_FAIL(" 5.e-2");
  TEST_PARSE_FLOAT_FAIL(" -.25");
  TEST_PARSE_FLOAT_FAIL("-1 00");
  TEST_PARSE_FLOAT_FAIL("-100ee-2");
  TEST_PARSE_FLOAT_FAIL("-148ex+2");
  TEST_PARSE_FLOAT_FAIL("-1.25ee+2");
  TEST_PARSE_FLOAT_FAIL("-1.2v5e+002");
  TEST_PARSE_FLOAT_FAIL("+.2w5");
  TEST_PARSE_FLOAT_FAIL("+e100");
  TEST_PARSE_FLOAT_FAIL("+100re-2");
  TEST_PARSE_FLOAT_FAIL("+14t8e+2");
  TEST_PARSE_FLOAT_FAIL("+1.25e+e2");
  return 0;
}

int float_equals(float a, float b) {
  return ((a - b) < EPSILON) && ((b - a) < EPSILON);
}

int test_sv_parse_float(cstring_view input, int will_fail, float expected) {
  float inputf;
  if (!sv_parse_float(input, &inputf)) {
    if (will_fail) {
      print_check();
      printf("Expected parse failure: '" sv_fmt "'\n", sv_arg(input));
      return 1;
    } else {
      print_x();
      printf("Unexpected parse failure: '" sv_fmt "'\n", sv_arg(input));
      return 0;
    }
  }

  if (will_fail) {
    print_x();
    printf("Expected parse to fail: '" sv_fmt "' == %f\n", sv_arg(input), inputf);
    return 0;
  }

  if (float_equals(expected, inputf)) {
    print_check();
    printf("'" sv_fmt "' == %f\n", sv_arg(input), inputf);
    return 1;
  }

  print_x();
  printf("'" sv_fmt "' != %f\n", sv_arg(input), inputf);

  return 0;
}

void print_check() {
  printf("[\xE2\x9C\x93] ");
}

void print_x() {
  printf("[x] ");
}